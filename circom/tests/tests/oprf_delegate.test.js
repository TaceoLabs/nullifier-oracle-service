const { wasm } = require("circom_tester");
const { expect } = require("chai");
const path = require("path");

describe("Oprf Delegate (d=10)", function () {
  this.timeout(10000);

  let circuit;
  before(async () => {
    circuit = await wasm(
      path.join(__dirname, "circuits/oprf_delegate_test.circom"),
      { include: [path.join(__dirname, "../../")] },
    );
    await circuit.loadConstraints();
  });


  it("kat0 success", async () => {
    const witness = await circuit.calculateWitness({
      user_pk: [
        [14199164337675793391174713240426010139664643213299039004201001564866076739277n, 15146074993696942642292541198592721564648235436624981110562628759405139023037n],
        [8374264022521132711781741456412929244803501110716064894973909683680234846943n, 17468463602721731953017895056766938800532460269618130649338880911788594695529n],
        [13610353140275889700040119751915617172687993581229729087437657393143052873716n, 5399747220458290938972943111172614602560248888338834186116162316588903503640n],
        [142111215835770646712414336013344173971128298228101131984672765701482170164n, 4380538414601652211461681807691082887745733260333838300671866136201054222602n],
        [18456852911164158042139128461381208958408113247540181466659142697577196551562n, 7494149510479008607718015602827050755683266261952197454266553891126690772262n],
        [17378318686669725315425184231029642257051065228194103970262464472501114985198n, 6642141683434156013346771848643813007360869512358515279814402288502197430517n],
        [3043337119305775634276632958219432415423615897425946863489574979813954741935n, 13528716426094187173874820701686218200980003178568139179666341925248755768726n]
      ],
      pk_index: 3n,
      query_s: 692359504600507514379328551390132770805552673156706063003994787838335216987n,
      query_r: [10935627389897453615401993283578742447585648447509485912135338502553373340652n, 17860790671452555874284843274918793777620080319285822479402815719351971127492n],
      cred_type_id: 12730065355521334556144255826749186084429370072642582576240378472655514698916n,
      cred_pk: [18138690791134023174059882991974409282755622105694553909066545004449069391521n, 18633504394586483778454657393283749011522831552533443162593438640728316398759n],
      cred_hashes: [18246339930073534667167986219768048568414949647513228618977073979170388604805n, 1463868183495224042600645335317249149988482788516360012035298372854991682333n],
      cred_genesis_issued_at: 11559186091148020414n,
      cred_expires_at: 2433451168095167542n,
      cred_s: 1817776555432592645414096041432814330980045774247273161542545851875126563224n,
      cred_r: [13838062506470704962192577214785702282164211021646606466624144169120318901801n, 631773350799796569590981051353548367315465861612009539404101369059085186298n],
      current_time_stamp: 1046024976639972392n,
      merkle_root: 12728493367796739047442428646911688142009901386565996950434096294576777159321n,
      depth: 10n,
      mt_index: 225n,
      siblings: [
        20145126631288986191570215910609245868393488219191944478236366445844375250869n,
        2455121972286674808869549714152349714206223604801818052723209294346684187305n,
        2688031480679618212356923224156338490442801298151486387374558740281106332049n,
        7260841701659063892287181594885047103826520447399840357432646043820090985850n,
        14264624174809365056092456028844144694862933637425998608510571382453050421969n,
        13367077320550519630911999863418302042067856699006993825537974968356422427445n,
        214678903408678002486556122306789455922347049616774171062257264890580087799n,
        8934255931615292796207589698979440249098767000376487422715387033237910160589n,
        11604210794019133877686484832610564879317509644833182169281087512926329127461n,
        18547636267779519404018917934516077568632802541582936154567712725787384033262n
      ],
      beta: 215076558263374814804716778384771319982769742478210153805222645214889298584n,
      dlog_e: 2430732418640147738390580097064164474797008935120931089282273078264784827452n,
      dlog_s: 668225191690581134876761126370930802273268221364757533542675862587682162734n,
      oprf_pk: [18583516951849911137589213560287888058904264954447406129266479391375859118187n, 11275976660222343476638781203652591255100967707193496820837437013048598741240n],
      oprf_response_blinded: [8006858964426423277634443578086941123144826043144560164802854554756901957313n, 19706533179614456247224867533272558391961941056514937931783396731569907600583n],
      session_id: 0n,
      oprf_response: [2433604529041261164486935273531691245856018714945774422518050899946367785271n, 2570793009618561818100168345531109268127332118778341373407966737578224905926n],
      nonce: 19413146054045297973885649588025613966856301528813738125853514129595782428910n,
      id_commitment_r: 18871704932868136054793192224838481843477328152662874950971209340503970202849n,
      encryption_sk: 1845266097319643908802818370170911164293680300997019730044553666779533165776n,
      mpc_public_keys: [
        [3848803846801342715845502844840948591747111421828703047849687060881094754025n, 16524358455171580101658948191579179649237051947214343059897555482482851794711n],
        [16280822375275474576070018529546192150053228801742785273147312066500627257028n, 7197498148386439368087977442407562772807354329277124134911855570987747974825n],
        [1723868089597081072862186670541740442165816810266025893514149025978161364463n, 18728909150449763761895332006897379152236312813542733338761123110829173951905n]
      ],
      rp_merkle_root: 7008989469364679076295557201520434017243009115204435822766059384795081690847n,
      rp_depth: 10n,
      rp_mt_index: 334n,
      rp_siblings: [
        4176855770021968762089114227379105743389356785527273444730337538746178730938n,
        16310982107959235351382361510657637894710848030823462990603022631860057699843n,
        3605361703005876910845017810180860777095882632272347991398864562553165819321n,
        19777773459105034061589927242511302473997443043058374558550458005274075309994n,
        7293248160986222168965084119404459569735731899027826201489495443245472176528n,
        4950945325831326745155992396913255083324808803561643578786617403587808899194n,
        9839041341834787608930465148119275825945818559056168815074113488941919676716n,
        18716810854540448013587059061540937583451478778654994813500795320518848130388n,
        8489481874657167625850402416022768218935811957398944701892791078040199225319n,
        13366227751236448055703219624443766518486274913732869981435105211514511486376n
      ],
      map_id_share: [
        7072354584330803739893341075959600662170009672799717087821974214692377537543n,
        17885221558895888060441738558710283599239203102366021944096727770820448633434n,
        18818909600451858644157731855844665915687516025666329655477706387638790820591n
      ],
      r_share: [
        13721691983499918028351090247414996537303665840643865831659579087433220869394n,
        10504527072856625374251918935304995810363256944839645422147112326469942932346n,
        9922136640310746679589505888952316195107449577468486901753282935448033947801n
      ],
      expiration: 19515264307125146297792905993864830562548050510809169375491859162741845474966n
    }, true);
    await circuit.assertOut(witness, {
      id_commitment: 9529767258191211960817313042611088032520010635337651347924666109510301895775n,
      map_id_commitment: 6688646652800461145401205186446066451608319002312655281797764492827786296681n,
      encryption_pk: [1870943925490415367247887703275024688651561144872653820895754064460650035354n, 21149104454264069989476496661807851228661229710566313174512759231778706562047n],
      ciphertexts: [
        [2868743046694708550630920532145352287337525225193107007484688871020310598747n, 7157135573936661613568439889972555922320502476955395572733192295510521041627n, 15959545138524866573728009712694301627359631367115133195895063716632204322082n, 6804125559026699730737375120935850237712107202209862331261931087796841110688n],
        [2268837384296765336312342068963556868843872161567349247978935642964661098235n, 1855314012756787161716642191267106025168901869278498551854729428951550352264n, 17125719438145182643509732992085798495958000526671348703322809143744706722688n, 9068191459827755199878156323176817228396549088167728297942832350533161549442n],
        [15499031596481756357745704653858969849427662590875726307591649713245424171522n, 15475936944931747077230703807721760359864464038134360655721216174015004519606n, 12282741165117609794328079675225187656451931733163033884690537364836644652800n, 19237102779187417720623904181921559699094298661004291967343773302307561041519n]
      ]
    });
    await circuit.checkConstraints(witness);
  });
});
